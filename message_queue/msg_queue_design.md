# 消息队列设计全览

## 设计版本对比表

| 版本 | 线程模型 | 容量限制 | 阻塞模式 | 数据结构 | 同步机制 | 复杂度 | 性能等级 |
|------|----------|----------|----------|----------|----------|--------|----------|
| 1. 单线程Queue | Single Thread | 无限制 | N/A | std::queue | 无 | ⭐ | 最高 |
| 2. 单线程循环队列 | Single Thread | 有界 | N/A | 环形缓冲区 | 无 | ⭐ | 最高 |
| 3. SPSC非阻塞 | SPSC | 有界 | 非阻塞 | 环形缓冲区 | 原子操作 | ⭐⭐ | 极高 |
| 4. SPSC阻塞 | SPSC | 有界 | 阻塞 | 环形缓冲区 | 原子操作+条件变量 | ⭐⭐ | 高 |
| 5. SPSC混合 | SPSC | 有界 | 可选超时 | 环形缓冲区 | 原子操作+条件变量 | ⭐⭐⭐ | 高 |
| 6. MPMC简单 | MPMC | 有界 | 阻塞 | std::queue | 互斥锁+条件变量 | ⭐⭐ | 中等 |
| 7. MPMC环形 | MPMC | 有界 | 阻塞 | 环形缓冲区 | 互斥锁+条件变量 | ⭐⭐⭐ | 中等 |
| 8. MPMC无界 | MPMC | 无限制 | 阻塞 | std::queue | 互斥锁+条件变量 | ⭐⭐ | 中等 |
| 9. 无锁MPMC | MPMC | 无限制 | 非阻塞 | 链表 | CAS操作 | ⭐⭐⭐⭐⭐ | 极高 |

## 详细设计说明

### 1. 单线程Queue
**设计特点**：
- 数据结构：`std::queue<T>`
- 操作：`push()`, `pop()`, `empty()`, `size()`
- 同步：无需同步
- 容量：无限制（受内存限制）

**适用场景**：
- 算法题解
- 单线程应用的缓冲
- 原型开发

### 2. 单线程循环队列
**设计特点**：
- 数据结构：`vector<T>` + head/tail指针
- 容量：固定大小，满时拒绝插入
- 优势：内存预分配，缓存友好

**适用场景**：
- 内存受限环境
- 实时系统（避免动态分配）
- 嵌入式开发

### 3. SPSC非阻塞
**设计特点**：
- 线程模型：一个生产者，一个消费者
- 同步：`atomic<size_t>` head/tail指针
- 内存排序：relaxed读自己，acquire读对方，release写给对方
- 返回：bool表示成功/失败

**适用场景**：
- 高频交易系统
- 音视频处理管道
- 游戏引擎的帧数据传递
- 网络IO与业务逻辑解耦

### 4. SPSC阻塞
**设计特点**：
- 基础：SPSC非阻塞 + 条件变量
- 同步：一个mutex（仅用于条件变量）
- 等待：队列满/空时线程休眠
- 返回：void（总是成功）

**适用场景**：
- 生产者-消费者模式
- 任务队列处理
- 日志异步写入
- CPU效率优先的场景

### 5. SPSC混合（超时等待）
**设计特点**：
- 策略：先自旋，再条件变量
- 参数：可选超时时间
- 返回：枚举值（SUCCESS/TIMEOUT/FULL/EMPTY）
- 优化：结合低延迟和CPU效率

**适用场景**：
- 需要超时控制的系统
- 对延迟和CPU使用都敏感的应用
- 可配置性能特性的通用库

### 6. MPMC简单
**设计特点**：
- 数据结构：`std::queue<T>`
- 同步：一个mutex保护整个队列
- 等待：条件变量not_full/not_empty
- 容量：可配置上限

**适用场景**：
- Web服务器请求处理
- 线程池任务分发
- 简单的多线程应用
- 学习和原型开发

### 7. MPMC环形
**设计特点**：
- 数据结构：环形缓冲区
- 同步：分离的push_mutex/pop_mutex
- 优势：生产和消费可并行
- 内存：预分配，缓存友好

**适用场景**：
- 高吞吐量的数据处理
- 批处理系统
- 多媒体流处理
- 服务器端应用

### 8. MPMC无界
**设计特点**：
- 容量：无限制（仅受内存限制）
- 优势：永不阻塞生产者
- 风险：内存可能无限增长
- 适合：生产速度不可控的场景

**适用场景**：
- 事件收集系统
- 日志聚合
- 消息中间件
- 突发流量处理

### 9. 无锁MPMC（最复杂）
**设计特点**：
- 算法：Michael & Scott无锁队列
- 数据结构：原子指针链表 + dummy节点
- 同步：CAS操作，无mutex
- 挑战：ABA问题，内存回收，协作推进

**适用场景**：
- 极高性能要求的系统
- 实时交易系统
- 高频数据采集
- 系统级基础设施

## 场景选择指南

### 按性能要求选择

**极低延迟（< 1μs）**：
- SPSC非阻塞
- 无锁MPMC

**低延迟（< 10μs）**：
- SPSC混合
- MPMC环形

**中等延迟（< 100μs）**：
- SPSC阻塞
- MPMC简单

**延迟不敏感**：
- 单线程版本
- MPMC无界

### 按线程模型选择

**单线程**：
- 单线程Queue（无界）
- 单线程循环队列（有界）

**一对一通信**：
- SPSC非阻塞（高性能）
- SPSC阻塞（简单易用）
- SPSC混合（平衡）

**多对多通信**：
- MPMC简单（入门）
- MPMC环形（高吞吐）
- MPMC无界（弹性容量）
- 无锁MPMC（极致性能）

### 按资源约束选择

**内存受限**：
- 循环队列版本（预分配）
- 避免无界版本

**CPU受限**：
- 阻塞版本（休眠等待）
- 避免自旋等待

**延迟受限**：
- 非阻塞版本
- 无锁版本

### 按开发复杂度选择

**快速原型**：
- 单线程Queue
- MPMC简单

**生产环境**：
- SPSC阻塞/混合
- MPMC环形

**性能调优**：
- SPSC非阻塞
- 无锁MPMC

## 设计演进路径

```
单线程Queue → SPSC非阻塞 → SPSC阻塞 → SPSC混合
     ↓              ↓            ↓
单线程循环   →   MPMC简单  →   MPMC环形  →  无锁MPMC
     ↓                          ↓
   嵌入式场景                MPMC无界
```

建议从左边简单版本开始，根据性能需求逐步向右演进。每个版本都有其价值和适用场景。